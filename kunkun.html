// Helper functions
const BtoGB = (bytes) => (bytes / 1024 / 1024 / 1024).toFixed(2);
const usagePercentage = (used, total) => ((used / total) * 100).toFixed(2);
const formatTime = (timestamp) => new Date(timestamp * 1000).toLocaleTimeString();

// 定义 isOutdated 函数
const isOutdated = (timestamp) => Math.floor(Date.now() / 1000) - timestamp > 1 * 60;

const App = {
    setup() {
        const servers = ref([]);
        const expandedStates = reactive({});
        const showFieldSelector = ref(false);
        const selectedFields = ref(JSON.parse(localStorage.getItem('selectedFields')) || ['hostname', 'loadAverages', 'memoryUsage']);

        const prevServersRef = ref({});
        const renderServers = ref({});

        const handleFieldSelection = (key) => {
            if (selectedFields.value.includes(key)) {
                selectedFields.value = selectedFields.value.filter(field => field !== key);
            } else {
                selectedFields.value.push(key);
            }
            localStorage.setItem('selectedFields', JSON.stringify(selectedFields.value));
        };

        const calculateCpuPercentages = (currentCpu, prevCpu) => {
            const diff = {
                cpu_us: currentCpu.cpu_user - (prevCpu.cpu_user || 0),
                cpu_sy: currentCpu.cpu_system - (prevCpu.cpu_system || 0),
                cpu_ni: currentCpu.cpu_nice - (prevCpu.cpu_nice || 0),
                cpu_id: currentCpu.cpu_idle - (prevCpu.cpu_idle || 0),
                cpu_wa: currentCpu.cpu_iowait - (prevCpu.cpu_iowait || 0),
                cpu_hi: currentCpu.cpu_irq - (prevCpu.cpu_irq || 0),
                cpu_st: currentCpu.cpu_steal - (prevCpu.cpu_steal || 0),
            };

            const total = Object.values(diff).reduce((sum, value) => sum + value, 0);

            if (total === 0) {
                return {
                    cpu_us_percent: prevCpu.cpu_us_percent || '0.00',
                    cpu_sy_percent: prevCpu.cpu_sy_percent || '0.00',
                    cpu_ni_percent: prevCpu.cpu_ni_percent || '0.00',
                    cpu_id_percent: prevCpu.cpu_id_percent || '0.00',
                    cpu_wa_percent: prevCpu.cpu_wa_percent || '0.00',
                    cpu_hi_percent: prevCpu.cpu_hi_percent || '0.00',
                    cpu_st_percent: prevCpu.cpu_st_percent || '0.00',
                };
            }

            return {
                cpu_us_percent: ((diff.cpu_us / total) * 100).toFixed(2),
                cpu_sy_percent: ((diff.cpu_sy / total) * 100).toFixed(2),
                cpu_ni_percent: ((diff.cpu_ni / total) * 100).toFixed(2),
                cpu_id_percent: ((diff.cpu_id / total) * 100).toFixed(2),
                cpu_wa_percent: ((diff.cpu_wa / total) * 100).toFixed(2),
                cpu_hi_percent: ((diff.cpu_hi / total) * 100).toFixed(2),
                cpu_st_percent: ((diff.cpu_st / total) * 100).toFixed(2),
            };
        };

        const calculateNetworkSpeed = (currentNet, prevNet) => {
            const timeDiff = currentNet.timestamp - prevNet.timestamp;

            const diffRx = currentNet.default_interface_net_rx_bytes - (prevNet.default_interface_net_rx_bytes || currentNet.default_interface_net_rx_bytes);
            const diffTx = currentNet.default_interface_net_tx_bytes - (prevNet.default_interface_net_tx_bytes || currentNet.default_interface_net_tx_bytes);

            if (diffRx === 0 && diffTx === 0) {
                return {
                    netRxSpeedKB: prevNet.netRxSpeedKB || 0.00,
                    netTxSpeedKB: prevNet.netTxSpeedKB || 0.00,
                };
            }

            return {
                netRxSpeedKB: (diffRx / 1024 / timeDiff).toFixed(2),
                netTxSpeedKB: (diffTx / 1024 / timeDiff).toFixed(2),
            };
        };

        const processIOData = (prevData, currentData) => {
            const timeDiff = currentData.timestamp - prevData.timestamp;

            const readsPerSecond = ((currentData.reads_completed - prevData.reads_completed) / timeDiff).toFixed(2);
            const writesPerSecond = ((currentData.writes_completed - prevData.writes_completed) / timeDiff).toFixed(2);

            const avgReadLatency = (currentData.reading_ms / currentData.reads_completed).toFixed(2);
            const avgWriteLatency = (currentData.writing_ms / currentData.writes_completed).toFixed(2);

            const diskUtilization = ((currentData.iotime_ms - prevData.iotime_ms) / (timeDiff * 1000000)).toFixed(2);

            const weightedIoTimePercent = ((currentData.weighted_io_time / currentData.iotime_ms)).toFixed(2);

            return {
                readsPerSecond,
                writesPerSecond,
                avgReadLatency,
                avgWriteLatency,
                diskUtilization,
                weightedIoTimePercent,
            };
        };

        const fetchData = async () => {
            try {
                const response = await axios.get(`${HOST}/status/latest`);
                const newServers = response.data;

                newServers.forEach(server => {
                    server.mem_really_used_mib = (server.mem_total_mib - (server.mem_free_mib + server.mem_buff_cache_mib)).toFixed(2);

                    const machineId = server.machine_id;
                    const prevServer = prevServersRef.value[machineId] || {};
                    const renderServer = renderServers.value[machineId] || {};

                    if (JSON.stringify(server) === JSON.stringify(prevServer)) {
                        return;
                    } else {
                        prevServersRef.value[machineId] = server;
                    }

                    const cpuPercentages = calculateCpuPercentages(server, prevServer);
                    const networkSpeed = calculateNetworkSpeed(server, prevServer);
                    const uptimeDays = `${Math.floor(server.uptime_s / 3600 / 24)}`;

                    renderServers.value[machineId] = {
                        ...server,
                        ...cpuPercentages,
                        ...networkSpeed,
                        ...processIOData(prevServer, server),

                        loadAverages: `${server.load_1min}/${server.load_5min}/${server.load_15min}`,
                        updateAt: formatTime(server.timestamp),
                        memoryUsage: {
                            used: (server.mem_really_used_mib / 1024).toFixed(2),
                            total: (server.mem_total_mib / 1024).toFixed(2),
                        },
                        tasksInfo: `${server.running_tasks}/${server.total_tasks}`,
                        trafficInfo: `${BtoGB(server.default_interface_net_rx_bytes)}/${BtoGB(server.default_interface_net_tx_bytes)}`,
                        connectionInfo: `${server.tcp_connections}/${server.udp_connections}`,
                        rootDiskInfo: {
                            used: BtoGB((server.root_disk_total_kb - server.root_disk_avail_kb) * 1024),
                            total: BtoGB(server.root_disk_total_kb * 1024),
                        },
                        isOffline: isOutdated(server.timestamp), // 使用 isOutdated 函数
                        uptimeDays: uptimeDays,
                    };
                });

                servers.value = Object.values(renderServers.value);
            } catch (error) {
                console.error('Error fetching data:', error);
            }
        };

        onMounted(() => {
            fetchData();
            const interval = setInterval(fetchData, 1000);
            return () => clearInterval(interval);
        });

        const toggleExpand = (machineId) => {
            expandedStates[machineId] = !expandedStates[machineId];
        };

        return {
            servers,
            expandedStates,
            showFieldSelector,
            selectedFields,
            handleFieldSelection,
            toggleExpand,
        };
    },
    template: `
        <div class="min-h-screen bg-gray-100 p-4">
            <h1 class="text-xl font-bold mb-4 text-center">KunKun Server Monitor</h1>
            <div class="space-y-2">
                <div class="p-3 py-0 cursor-pointer rounded-lg transition-colors flex items-center justify-between text-sm">
                    <p>Online {{ servers.filter(server => !isOutdated(server.timestamp)).length }}/{{ servers.length }}</p>
                    <button class="p-1 text-gray-500 hover:text-gray-700" @click="showFieldSelector = true">⚙️</button>
                </div>
                <Server
                    v-for="server in servers"
                    :key="server.machine_id"
                    :server="server"
                    :isExpanded="expandedStates[server.machine_id] || false"
                    :selectedFields="selectedFields"
                    @onToggleExpand="toggleExpand(server.machine_id)"
                    @onFieldSelection="handleFieldSelection"
                />
            </div>
            <div v-if="showFieldSelector" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
                <div class="bg-white p-4 rounded-lg shadow-lg">
                    <div class="py-2">选择优先显示字段</div>
                    <div class="grid grid-cols-3 gap-2 p-2">
                        <label v-for="key in Object.keys(TITLES)" :key="key" class="flex items-center text-gray-400 text-xs">
                            <input
                                type="checkbox"
                                :checked="selectedFields.includes(key)"
                                @change="handleFieldSelection(key)"
                            />
                            <span class="ml-2">{{ TITLES[key][0] }}</span>
                        </label>
                    </div>
                    <button
                        class="mt-4 py-2 px-4 text-xs inline-flex items-center rounded-md bg-green-50 px-2 py-1 text-xs font-medium text-green-700 ring-1 ring-inset ring-green-600/20"
                        @click="showFieldSelector = false"
                    >
                        确认
                    </button>
                </div>
            </div>
        </div>
    `,
};
